<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>🐠 Proxying</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/style.css" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/pilcrow.css" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/hljs-github.min.css"/>
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css"/>
  <link rel="shortcut icon" href="/Podium/docs/assets/podium.png" type="image/x-icon">
</head>
<body>
  <header>
    <a class="logo" href="/Podium">
      <img class="podium" src="/Podium/docs/assets/podium.png">
      Podium
    </a>
    <div class="links">
      <a href="https://github.schibsted.io/Podium" target="_blank">GitHub</a>
    </div>
  </header>
  <div class="content">
    <nav class="main-navigation">
      
      <h3>Podium</h3>
      <ul>
        <li><a href="/Podium/docs/podium/conceptual_overview.html">📚 Overview</a></li>
      </ul>
      
      <h3>Podlet Guides</h3>
      <ul>
        <li><a href="/Podium/docs/podlets/getting_started.html">🚀 Getting Started</a></li>
        <li><a href="/Podium/docs/podlets/fallbacks.html">🔌 Fallbacks</a></li>
        <li><a href="/Podium/docs/podlets/context.html">✂️ Context</a></li>
        <li><a href="/Podium/docs/podlets/proxying.html">🐠 Proxying</a></li>
        <li><a href="/Podium/docs/podlets/local_development.html">🔥 Development</a></li>
      </ul>

      <h3>Layout Guides</h3>
      <ul>
        <li><a href="/Podium/docs/layouts/getting_started.html">🚀 Getting Started</a></li>
        <li><a href="/Podium/docs/layouts/context.html">✂️ Context</a></li>
        <li><a href="/Podium/docs/layouts/unavailable_podlets.html">🔌 Unavailable Podlets</a></li>
        <li><a href="/Podium/docs/layouts/dynamic_routes.html">🐠 Dynamic Routes</a></li>
        <li><a href="/Podium/docs/layouts/assets.html">📦 Assets</a></li>
        <li><a href="/Podium/docs/layouts/local_development.html">🔥 Development</a></li>
      </ul>

      <h3>API Docs</h3>
      <ul>
        <li><a href="https://github.schibsted.io/Podium/podlet/blob/master/README.md">📚 Podlet</a></li>
        <li><a href="https://github.schibsted.io/Podium/layout/blob/master/README.md">📚 Layout</a></li>
        <li><a href="https://github.schibsted.io/Podium/context/blob/master/README.md">📚 Context</a></li>
        <li><a href="https://github.schibsted.io/Podium/proxy/blob/master/README.md">📚 Proxy</a></li>
        <li><a href="https://github.schibsted.io/Podium/client/blob/master/README.md">📚 Client</a></li>
      </ul>
    </nav>
    <main class="markdown-body"><h1 id="🐠-proxying"><a class="header-link" href="#🐠-proxying"></a>🐠 Proxying</h1>
<h2 id="background"><a class="header-link" href="#background"></a>Background</h2>
<p>While Podium does not enforce what type of infrastructure is used to run podlet and layout servers, a common decision that will have to be made when using Podium is whether podlet servers should be publicly accessible or whether they should be accessible only through the layout server. This decision can impact how client side code is written due to a common need to communicate back directly from client code to podlet server.</p>
<p>In some cases, you may not wish to expose your podlets to the outside world, instead prefering to expose only layouts and let the layouts do the work of fetching content from internally placed podlets.</p>
<p>A podlet server that is not exposed to the outside world except via a layout server that consumes its content may still need a way to define additional routes and make them publicly available.</p>
<p>Two very common use cases for this are when performing form submissions against a podlet and when making AJAX requests from client side code to a podlet. For example, a podlet might define an additional route at <code>/api</code> which is provided so that the client side JavaScript served by this podlet can fetch additional data asynchonously after page load.</p>
<p>By default, a podlet serves up its content at <code>/</code>. While you can change this to a different route, <code>/content</code> for example, out of the box, no other routes will be accessible. In our example above, it will not be possible for the client side JavaScript code to make a request to <code>/api</code> as this code is now running in the layout and the layout does not provide an <code>/api</code> route. And since the podlet itself has no public address, there&#39;s no way to send a request directly to the podlet&#39;s <code>/api</code> route using an absolute URL either.</p>
<p>To cater for this need to communicate directly with podlet servers, Podium provides a proxy feature. A Podium proxy is a transparent proxy that is mounted in the layout server making it possible to send any http request through it back to the podlet server.</p>
<p>If your infrastructure is setup such that podlet servers are only available through layout servers then using the Podium Proxy is the prefered way to make parts of a podlet server publically available.</p>
<p>If, on the other hand, your infrastructure is setup such that podlet servers are fully publically available then the approach taken can simply be for client side code to communicate with the podlet server directly by enabling <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a>.</p>
<h2 id="podium-proxy"><a class="header-link" href="#podium-proxy"></a>Podium Proxy</h2>
<p>Podium proxying is the Podium way for a podlet to inform any layout servers that consume it that there are additional routes and that they should be given public access via routes on the layout server.</p>
<h3 id="how-it-works"><a class="header-link" href="#how-it-works"></a>How it works</h3>
<p>For each proxy you define in a podlet, a namespaced route will be mounted on a layout which will proxy requests back to the podlet. This works as follows:</p>
<ul class="list">
<li>A podlet defines its proxy routes</li>
<li>A podlet puts the location of the proxy routes into its manifest file</li>
<li>A layout reads a podlets manifest file including proxy information</li>
<li>A layout creates namespaced proxy routes</li>
<li>A layout sends information to the podlet via context headers about the public location of these routes</li>
<li>A podlet uses context headers to construct URLs pointing to the layout&#39;s proxy endpoints</li>
</ul>
<p>In a podlet&#39;s manifest, a proxy object can be used to define up to 4 proxy routes like so:</p>
<pre class="hljs"><code>{
    ...
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"myPodlet"</span>,
    <span class="hljs-attr">"proxy"</span>: {
        <span class="hljs-attr">"api"</span>: <span class="hljs-string">"/api"</span>
    }
    ...
}</code></pre><p>This will result in a URL being mounted on the layout server at:</p>
<pre class="hljs"><code>/&lt;layout-pathname&gt;/&lt;prefix&gt;/&lt;podlet-name&gt;/&lt;proxy-namespace&gt;</code></pre><p>where:</p>
<ul class="list">
<li><code>&lt;layout-pathname&gt;</code>: <code>pathname</code> argument given <code>new Layout({ pathname: &#39;...&#39; })</code></li>
<li><code>&lt;prefix&gt;</code>: defaults to <code>podium-resource</code></li>
<li><code>&lt;podlet-name&gt;</code>: podlet manifest <code>name</code> value</li>
<li><code>&lt;proxy-namespace&gt;</code>: podlet manifest <code>proxy.&lt;key&gt;</code></li>
</ul>
<p>So for a layout running locally on port <code>1337</code> using <code>pathname</code> &#39;myLayout&#39; and consuming a podlet that serves the manifest file above we should be able to send requests to:</p>
<p><code>http://localhost:1337/myLayout/podium-resource/myPodlet/api</code></p>
<p>and expect that our requests would be proxied on to our podlet&#39;s <code>/api</code> route.</p>
<h3 id="programmatically-defining-proxy-routes"><a class="header-link" href="#programmatically-defining-proxy-routes"></a>Programmatically defining proxy routes</h3>
<p>It&#39;s not necessary to define proxy routes in a manifest file manually. There is a <code>podlet.proxy()</code> helper method you should use to define proxy routes and have the manifest file fields populated for you. The following example will achieve the same thing as shown earlier using this helper.</p>
<p><em>Example</em></p>
<pre class="hljs"><code>podlet.proxy(<span class="hljs-string">'/api'</span>, <span class="hljs-string">'api'</span>);</code></pre><p>What&#39;s more, we can also define the route itself at the same time.</p>
<p><em>Example</em></p>
<pre class="hljs"><code>app.get(podlet.proxy(<span class="hljs-string">'/api'</span>, <span class="hljs-string">'api'</span>), (req, res) =&gt; {
    res.json({ <span class="hljs-attr">key</span>: <span class="hljs-string">'value'</span> });
});</code></pre><p>There are a maximum of 4 proxies, however it is possible to mount multiple routes under a single proxy.</p>
<p><em>Example</em></p>
<pre class="hljs"><code>podlet.proxy(<span class="hljs-string">'/api'</span>, <span class="hljs-string">'api'</span>);

app.get(<span class="hljs-string">'/api/cats'</span>, (req, res) =&gt; {
    res.json([{ <span class="hljs-attr">name</span>: <span class="hljs-string">'fluffy'</span> }]);
});
<span class="hljs-comment">// http://localhost:1337/myLayout/podium-resource/myPodlet/api/cats</span>

app.get(<span class="hljs-string">'/api/dogs'</span>, (req, res) =&gt; {
    res.json([{ <span class="hljs-attr">name</span>: <span class="hljs-string">'rover'</span> }]);
});
<span class="hljs-comment">// http://localhost:1337/myLayout/podium-resource/myPodlet/api/dogs</span></code></pre><p>Specifying an absolute URL is also possible in which case the layout will mount a proxy directly to the URL, bypassing the podlet entirely.</p>
<p><em>Example</em></p>
<pre class="hljs"><code>podlet.proxy(<span class="hljs-string">'remote-api'</span>, <span class="hljs-string">'http://&lt;some-service:port&gt;/api'</span>);

<span class="hljs-comment">// http://localhost:1337/myLayout/podium-resource/myPodlet/remote-api</span></code></pre><h3 id="constructing-proxy-urls"><a class="header-link" href="#constructing-proxy-urls"></a>Constructing Proxy URLs</h3>
<p>When creating a podlet with proxy routes, it&#39;s necessary to be able to dynamically, programmatically determine the location of these proxy routes.</p>
<p>The base URL can be constructed by joining together values plucked from the Podium context like so.</p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> { URL } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>); <span class="hljs-comment">// not required in node &gt;=10</span>

app.get(podlet.content(), (req, res) =&gt; {
    <span class="hljs-keyword">const</span> { mountOrigin, publicPathname } = res.locals.podium.context;
    <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(publicPathname, mountOrigin);

    <span class="hljs-comment">// prints base URL under which all proxy routes are located</span>
    <span class="hljs-built_in">console</span>.log(url.href);
});</code></pre><p>The path to a given endpoint can then be constructed by joining this base URL together with the namespace key given to the <code>podlet.proxy()</code> method like so:</p>
<pre class="hljs"><code><span class="hljs-comment">// define and create an API proxy route</span>
app.get(podlet.proxy(<span class="hljs-string">'/api'</span>, <span class="hljs-string">'api'</span>), (req, res) =&gt; {
    res.json({...});
});

app.get(podlet.content(), (req, res) =&gt; {
    <span class="hljs-comment">// construct an absolute URL to the API proxy route</span>
     <span class="hljs-keyword">const</span> { mountOrigin, publicPathname } = res.locals.podium.context;
    <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(publicPathname, mountOrigin);

    <span class="hljs-comment">// prints specific absolute URL to API proxy endpoint</span>
    <span class="hljs-built_in">console</span>.log(url.href + <span class="hljs-string">'api'</span>);
});</code></pre><h3 id="example:-client-side-javascript-fetching-data-from-a-/content-route"><a class="header-link" href="#example:-client-side-javascript-fetching-data-from-a-/content-route"></a>Example: client side JavaScript fetching data from a /content route</h3>
<pre class="hljs"><code><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> Podlet = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@podium/podlet'</span>);

<span class="hljs-keyword">const</span> podlet = <span class="hljs-keyword">new</span> Podlet({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'myPodlet'</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>,
    <span class="hljs-attr">pathname</span>: <span class="hljs-string">'/'</span>,
});

<span class="hljs-keyword">const</span> app = express();

app.get(podlet.manifest(), (req, res) =&gt; {
    res.json(podlet);
});

app.get(podlet.proxy(<span class="hljs-string">'/content'</span>, <span class="hljs-string">'content'</span>), (req, res) =&gt; {
    res.send(<span class="hljs-string">'This is the actual content for the page'</span>);
});

app.get(podlet.content(), (req, res) =&gt; {
    <span class="hljs-keyword">const</span> { mountOrigin, publicPathname } = res.locals.podium.context;
    <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(publicPathname, mountOrigin);

    res.send(<span class="hljs-string">`
        &lt;div id="content-placeholder"&gt;&lt;/div&gt;
        &lt;script&gt;
            fetch('<span class="hljs-subst">${url.href + <span class="hljs-string">'content'</span>}</span>')
                .then((response) =&gt; response.text())
                .then(content =&gt; {
                    const el = document.getElementById('content-placeholder');
                    el.innerHTML = content;
                });
        &lt;/script&gt;
    `</span>);
});

app.listen(<span class="hljs-number">7100</span>);</code></pre><h2 id="next-steps"><a class="header-link" href="#next-steps"></a>Next steps</h2>
<ul class="list">
<li><a href="/Podium/docs/podlets/local_development.html">read about improving your podlet development workflow</a></li>
</ul>
    </main>
  </div>
  <script>
    (function () {
      var pathname = window.location.pathname.substr(1);
      var activeLink = document.querySelector('a[href="' + pathname + '"]');

      activeLink.classList.add('selected');
    })();
  </script>
</body>
</html>
