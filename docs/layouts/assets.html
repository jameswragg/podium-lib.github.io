<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>📦 Assets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/style.css" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/pilcrow.css" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/hljs-github.min.css"/>
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css"/>
  <link rel="shortcut icon" href="/Podium/docs/assets/podium.png" type="image/x-icon">
</head>
<body>
  <header>
    <a class="logo" href="/Podium">
      <img class="podium" src="/Podium/docs/assets/podium.png">
      Podium
    </a>
    <div class="links">
      <a href="https://github.schibsted.io/Podium" target="_blank">GitHub</a>
    </div>
  </header>
  <div class="content">
    <nav class="main-navigation">
      
      <h3>Podium</h3>
      <ul>
        <li><a href="/Podium/docs/podium/conceptual_overview.html">📚 Overview</a></li>
      </ul>
      
      <h3>Podlet Guides</h3>
      <ul>
        <li><a href="/Podium/docs/podlets/getting_started.html">🚀 Getting Started</a></li>
        <li><a href="/Podium/docs/podlets/fallbacks.html">🔌 Fallbacks</a></li>
        <li><a href="/Podium/docs/podlets/context.html">✂️ Context</a></li>
        <li><a href="/Podium/docs/podlets/assets.html">📦 Assets</a></li>
        <li><a href="/Podium/docs/podlets/proxying.html">🐠 Proxying</a></li>
        <li><a href="/Podium/docs/podlets/local_development.html">🔥 Development</a></li>
      </ul>

      <h3>Layout Guides</h3>
      <ul>
        <li><a href="/Podium/docs/layouts/getting_started.html">🚀 Getting Started</a></li>
        <li><a href="/Podium/docs/layouts/context.html">✂️ Context</a></li>
        <li><a href="/Podium/docs/layouts/unavailable_podlets.html">🔌 Unavailable Podlets</a></li>
        <li><a href="/Podium/docs/layouts/sharing_state.html">🐠 Sharing State</a></li>
        <li><a href="/Podium/docs/layouts/assets.html">📦 Assets</a></li>
        <li><a href="/Podium/docs/layouts/local_development.html">🔥 Development</a></li>
      </ul>

      <h3>API Docs</h3>
      <ul>
        <li><a href="https://github.schibsted.io/Podium/podlet/blob/master/README.md">📚 Podlet</a></li>
        <li><a href="https://github.schibsted.io/Podium/layout/blob/master/README.md">📚 Layout</a></li>
        <li><a href="https://github.schibsted.io/Podium/context/blob/master/README.md">📚 Context</a></li>
        <li><a href="https://github.schibsted.io/Podium/proxy/blob/master/README.md">📚 Proxy</a></li>
        <li><a href="https://github.schibsted.io/Podium/client/blob/master/README.md">📚 Client</a></li>
      </ul>
    </nav>
    <main class="markdown-body"><h1 id="📦-assets"><a class="header-link" href="#📦-assets"></a>📦 Assets</h1>
<p>PODLET</p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> podlet = <span class="hljs-keyword">new</span> Podlet({ ... });
<span class="hljs-keyword">const</span> assets = <span class="hljs-keyword">new</span> Assets({ <span class="hljs-attr">server</span>: <span class="hljs-string">'http://localhost:3031'</span> });

<span class="hljs-keyword">const</span> ready = <span class="hljs-built_in">Promise</span>.all([,
    assets.publish(<span class="hljs-string">'unique-id'</span>, <span class="hljs-string">'/path/to/script.js'</span>),
    assets.publish(<span class="hljs-string">'unique-id'</span>, <span class="hljs-string">'/path/to/style.css'</span>),
]);

app.use(<span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">await</span> ready();
    next();
})

app.use(podlet.middleware());

app.get(<span class="hljs-string">'/manifest.json'</span>, (req, res) =&gt; {
    res.send(podlet);
});

app.get(<span class="hljs-string">'/'</span>, (req, res) =&gt; {
    res.send(<span class="hljs-string">`&lt;div&gt;Some podlet content&lt;/div&gt;`</span>);
});

app.listen(<span class="hljs-number">7100</span>);</code></pre><p>LAYOUT</p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> layout = <span class="hljs-keyword">new</span> Layout({ ... });

layout.client.register({ ... });
layout.client.register({ ... });
layout.client.register({ ... });

<span class="hljs-keyword">const</span> assets = <span class="hljs-keyword">new</span> Assets({ <span class="hljs-attr">server</span>: <span class="hljs-string">'http://localhost:3031'</span> });

<span class="hljs-keyword">const</span> ready = <span class="hljs-built_in">Promise</span>.all([
    assets.publish(<span class="hljs-string">'another-unique-id'</span>, <span class="hljs-string">'/path/to/client.js'</span>),
    assets.publish(<span class="hljs-string">'another-unique-id'</span>, <span class="hljs-string">'/path/to/style.css'</span>),
]).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">Promise</span>.all([
    assets.bundle.js(<span class="hljs-string">'another-unique-id'</span>, <span class="hljs-string">'unique-id'</span>),
    assets.bundle.css(<span class="hljs-string">'another-unique-id'</span>, <span class="hljs-string">'unique-id'</span>),
]));

app.use(<span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">await</span> ready();
    next();
})

app.use(layout.middleware());

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> [js, css] = <span class="hljs-built_in">Promise</span>.all([
        assets.js(),
        assets.css(),
    ]);
    res.send(<span class="hljs-string">`
        &lt;html&gt;
            &lt;head&gt;
                <span class="hljs-subst">${css.map(href =&gt; <span class="hljs-string">`&lt;link rel="stylesheet" href="<span class="hljs-subst">${href}</span>" /&gt;`</span>).join(<span class="hljs-string">'\n'</span>)}</span>
            &lt;/head&gt;
            &lt;body&gt;
                ...
                <span class="hljs-subst">${js.map(src =&gt; <span class="hljs-string">`&lt;script src="<span class="hljs-subst">${src}</span>"&gt;&lt;/script&gt;`</span>).join(<span class="hljs-string">'\n'</span>)}</span>
            &lt;/body&gt;
        &lt;/html&gt;
    `</span>);
});

...</code></pre><p>Use cases</p>
<ul class="list">
<li>Request to layout comes in and everything waits until assets are resolved. (published, bundled and url computed).</li>
<li>Ready checks do the waiting for assets to be resolved.</li>
<li>Get a calculated URL to a bundle</li>
</ul>
<p>LAYOUT</p>
<!-- publish js and css assets -->
<p>assets.publish(tag, path.js)
assets.publish(tag, path.css)</p>
<!-- bundle a set of publishing tags -->
<p>assets.bundle.js(tag, tag, tag, ...)
assets.bundle.css(tag, tag, tag, ...)</p>
<!-- wait for publishing and bundling to be complete -->
<p>assets.ready()
assets.middleware()</p>
<!-- synchronously get bundle url arrays for js and css -->
<p>assets.script() =&gt; [ url ]
assets.style() =&gt; [ url ]</p>
<p>PODLET</p>
<!-- publish js and css assets -->
<p>assets.publish(tag, path.js)
assets.publish(tag, path.css)</p>
<!-- wait for publishing to be complete -->
<p>assets.middleware()
assets.ready()</p>
<!-- synchronously get asset hashes for js and css -->
<p>Given tags, make me a bundle:</p>
<p>=&gt; tag1,tag2,tag3
=&gt; as45d3asd453as.json, da54s3d54as3d5.json, sa76d5a67sd5a76sd5.json</p>
<p>Given tags, give me a url:</p>
<p>=&gt; tag1,tag2,tag3
=&gt; as45d3asd453as.json, da54s3d54as3d5.json, sa76d5a67sd5a76sd5.json
=&gt; 5as43d45sa3d4asd45.js</p>
<p>Given a tag and and asset feed, give me a url:</p>
<p>=&gt; tag + [feed]
=&gt; perform bundle
=&gt; build url</p>
<p>bundle made up of feeds with these hashes:
as45d3asd453as, da54s3d54as3d5, sa76d5a67sd5a76sd5</p>
<p>publish
=&gt; tag, [feed]
=&gt; hash feed to get name -&gt; fds12dfs12d3s1df23.json
=&gt; set tag file to point to fds12dfs12d3s1df23.json
=&gt; hunt for tag in tags when found. eg. tag in [tag, tag2, tag3]
=&gt; lookup all hashes for all tags. eg. [tag, tag2, tag3] =&gt; [as45d3asd453as.json, da54s3d54as3d5.json, sa76d5a67sd5a76sd5.json]
=&gt; hash together hashes to produce 1 hash and check if file exists: eg. [as45d3asd453as.json, da54s3d54as3d5.json, sa76d5a67sd5a76sd5.json] -&gt; asdas65456sd4.js
=&gt; produce new bundle if not</p>
<p>bundle
=&gt; [tag, tag2, tag3], &#39;js&#39;
=&gt; lookup all hashes for all tags. eg. [tag, tag2, tag3] =&gt; [as45d3asd453as.json, da54s3d54as3d5.json, sa76d5a67sd5a76sd5.json]
=&gt; hash together hashes to produce 1 hash and check if file exists: eg. [as45d3asd453as.json, da54s3d54as3d5.json, sa76d5a67sd5a76sd5.json] -&gt; asdas65456sd4.js
=&gt; produce new bundle if not</p>
<p>url
=&gt; [tag, tag2, tag3], &#39;js&#39;
=&gt; lookup all hashes for all tags. eg. [tag, tag2, tag3] =&gt; [as45d3asd453as.json, da54s3d54as3d5.json, sa76d5a67sd5a76sd5.json]
=&gt; hash together hashes to produce 1 hash and check if file exists: eg. [as45d3asd453as.json, da54s3d54as3d5.json, sa76d5a67sd5a76sd5.json] -&gt; asdas65456sd4.js</p>
<p>assets.publish(&#39;unique-id&#39;, &#39;/path/to/script.js&#39;);
podlet.js(&#39;unique-id&#39;);</p>
    </main>
  </div>
  <script>
    (function () {
      var pathname = window.location.pathname.substr(1);
      var activeLink = document.querySelector('a[href="' + pathname + '"]');

      activeLink.classList.add('selected');
    })();
  </script>
</body>
</html>
