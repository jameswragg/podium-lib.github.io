<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>✂️ Context</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/style.css" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/pilcrow.css" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/hljs-github.min.css"/>
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css"/>
  <link rel="shortcut icon" href="/Podium/docs/assets/podium.png" type="image/x-icon">
</head>
<body>
  <header>
    <a class="logo" href="/Podium">
      <img class="podium" src="/Podium/docs/assets/podium.png">
      Podium
    </a>
    <div class="links">
      <a href="https://github.schibsted.io/Podium" target="_blank">GitHub</a>
    </div>
  </header>
  <div class="content">
    <nav class="main-navigation">
      
      <h3>Podium</h3>
      <ul>
        <li><a href="/Podium/docs/podium/conceptual_overview.html">📚 Overview</a></li>
      </ul>
      
      <h3>Podlet Guides</h3>
      <ul>
        <li><a href="/Podium/docs/podlets/getting_started.html">🚀 Getting Started</a></li>
        <li><a href="/Podium/docs/podlets/fallbacks.html">🔌 Fallbacks</a></li>
        <li><a href="/Podium/docs/podlets/context.html">✂️ Context</a></li>
        <li><a href="/Podium/docs/podlets/proxying.html">🐠 Proxying</a></li>
        <li><a href="/Podium/docs/podlets/local_development.html">🔥 Development</a></li>
      </ul>

      <h3>Layout Guides</h3>
      <ul>
        <li><a href="/Podium/docs/layouts/getting_started.html">🚀 Getting Started</a></li>
        <li><a href="/Podium/docs/layouts/context.html">✂️ Context</a></li>
        <li><a href="/Podium/docs/layouts/unavailable_podlets.html">🔌 Unavailable Podlets</a></li>
        <li><a href="/Podium/docs/layouts/sharing_state.html">🐠 Sharing State</a></li>
        <li><a href="/Podium/docs/layouts/assets.html">📦 Assets</a></li>
        <li><a href="/Podium/docs/layouts/local_development.html">🔥 Development</a></li>
      </ul>

      <h3>API Docs</h3>
      <ul>
        <li><a href="https://github.schibsted.io/Podium/podlet/blob/master/README.md">📚 Podlet</a></li>
        <li><a href="https://github.schibsted.io/Podium/layout/blob/master/README.md">📚 Layout</a></li>
        <li><a href="https://github.schibsted.io/Podium/context/blob/master/README.md">📚 Context</a></li>
        <li><a href="https://github.schibsted.io/Podium/proxy/blob/master/README.md">📚 Proxy</a></li>
        <li><a href="https://github.schibsted.io/Podium/client/blob/master/README.md">📚 Client</a></li>
      </ul>
    </nav>
    <main class="markdown-body"><h1 id="✂️-context"><a class="header-link" href="#✂️-context"></a>✂️ Context</h1>
<p>A Podlet is intended to be used within multiple Layouts but for this to be possible a Podlet
needs to be able to access certain pieces of data from each Layout server so that it can
determine how to respond.</p>
<p>The purpose of the Podium Context then is to give a Podlet access to background contextual information about each incoming HTTP request so that the Podlet can taylor its response accordingly.</p>
<p>More specifically, a Podlet can make use of the context to:</p>
<ul class="list">
<li>construct URLs back to the Layout where the request originated</li>
<li>respond differently depending on locale eg. <code>en-US</code> or <code>no-NO</code></li>
<li>respond differently depending on what type of device environment was used to make the request eg. <code>mobile</code> or <code>desktop</code></li>
<li>respond differently depending on whether the layout is in debug mode or not</li>
</ul>
<p>In Podium, this context information is sent as a set of HTTP headers with every request (including proxy requests) from a
Layout server to a Podlet.</p>
<h2 id="default-context-variables"><a class="header-link" href="#default-context-variables"></a>Default Context variables</h2>
<p>Podium has a default set of Context variables which are always present. These are:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Header Name</th>
<th>Context Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Debug</td>
<td><code>podium-debug</code></td>
<td><code>debug</code></td>
<td>A boolean value informing the Podlet whether the Layout is in debug mode or not. Defaults to <code>false</code></td>
</tr>
<tr>
<td>Locale</td>
<td><code>podium-locale</code></td>
<td><code>locale</code></td>
<td>A <a href="https://tools.ietf.org/html/bcp47">bcp47</a> compliant locale string with locale information from the Layout. Defaults to <code>en-US</code></td>
</tr>
<tr>
<td>Device Type</td>
<td><code>podium-device-type</code></td>
<td><code>deviceType</code></td>
<td>A guess (based on user-agent) as to the device type of the browser requesting the page from a Layout server. Possible values are <code>desktop</code>, <code>tablet</code> and <code>mobile</code>. Defaults to <code>desktop</code></td>
</tr>
<tr>
<td>Mount Origin</td>
<td><code>podium-mount-origin</code></td>
<td><code>mountOrigin</code></td>
<td>URL origin of the inbound request to the Layout server. For example, if the Layout server is serving requests on the domain <a href="http://www.foo.com">http://www.foo.com</a> this value will be <code>http://www.foo.com</code></td>
</tr>
<tr>
<td>Mount Pathname</td>
<td><code>podium-mount-pathname</code></td>
<td><code>mountPathname</code></td>
<td>URL path to where a Layout is mounted in an HTTP server. This value is the same as the layout&#39;s <code>pathname</code> option. For example, if the Layout server has mounted a Layout on the pathname <code>/bar</code> (<a href="http://www.foo.com/bar">http://www.foo.com/bar</a>) this value will be <code>/bar</code>.</td>
</tr>
<tr>
<td>Public Pathname</td>
<td><code>podium-public-pathname</code></td>
<td><code>publicPathname</code></td>
<td>URL path to where a Layout server has mounted a Proxy in order to proxy public traffic to a Podlet. The full public pathname is built up by joining together the value of Mount Pathname with a prefix value. The prefix value is there to define a namespace to isolate the proxy from other HTTP routes defined under the same mount pathname. The default prefix value is <code>podium-resource</code>. For example, if the Layout server has mounted a Layout on the pathname <code>/bar</code> (<a href="http://www.foo.com/bar">http://www.foo.com/bar</a>) this value will be <code>/bar/podium-resource/</code>.</td>
</tr>
</tbody>
</table>
<h2 id="consuming-context-values-in-a-podlet"><a class="header-link" href="#consuming-context-values-in-a-podlet"></a>Consuming Context values in a Podlet</h2>
<p>(For information on working with the Podium Context within Layouts including setting defaults and adding values, please see the <a href="https://github.schibsted.io/Podium/layout">@podium/layout</a> module documentation.)</p>
<p>Since Context values are sent to Podlets from Layouts as headers, to make them easier to work with, the <a href="https://github.schibsted.io/Podium/podlet">@podium/podlet</a> module contains a <code>de-serializer</code> which converts context headers into object keys and values and places them on the HTTP response object at <code>res.locals.podium.context</code> for use in later middleware and/or routes.</p>
<p>When you mount the Podlet&#39;s middleware into an app this de-serialization process will occur automatically on each request.</p>
<p><em>Example: adding podlet middleware</em></p>
<pre class="hljs"><code>app.use(podlet.middleware());</code></pre><p>Note: As shown in the table above, context names are converted from <a href="https://en.wikipedia.org/wiki/Kebab_case">kebab case</a> to <a href="https://en.wikipedia.org/wiki/Camel_case">camel case</a> and the <code>podium</code> prefix is removed so the <code>podium-mount-origin</code> header will be set as <code>mountOrigin</code> on <code>res.locals.podium.context</code>.</p>
<p><em>Example: accessing de-serialized context values in later middleware</em></p>
<pre class="hljs"><code>app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-comment">// res.locals.podium.context.locale</span>
    next();
});</code></pre><p><em>Example: accessing de-serialized context values in an express route</em></p>
<pre class="hljs"><code>app.get(<span class="hljs-string">'/'</span>, (req, res, next) =&gt; {
    <span class="hljs-comment">// res.locals.podium.context.deviceType</span>
});</code></pre><h3 id="url-construction"><a class="header-link" href="#url-construction"></a>URL construction</h3>
<p>Perhaps the most important thing the Context is typically used for is to construct URLs linking back to the Layout a Podlet is being sent a request from.</p>
<p>In a Podlet, the origin of a layout server will be found at <code>res.locals.podium.context.mountOrigin</code>
and the pathname to the layout server will be found at <code>res.locals.podium.context.mountPathname</code>.</p>
<p>These adher to the <a href="https://url.spec.whatwg.org/">WHATWG URL</a> spec so we can easily compose full URLs by using the <a href="https://nodejs.org/api/url.html#url_class_url">URL</a> module in node.js.</p>
<p><em>Example: using the URL module to construct urls from context values</em></p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> { URL } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>);
<span class="hljs-keyword">const</span> { mountOrigin, mountPathname } = res.locals.podium.context;
<span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(mountPathname, mountOrigin);
<span class="hljs-comment">// url.href =&gt; &lt;mountOrigin&gt;/&lt;mountPathname&gt;</span>
<span class="hljs-comment">// eg. http://localhost:3040/cats</span></code></pre><p><em>Example: using the URL module to construct proxy urls from context values</em></p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> { URL } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>);
<span class="hljs-keyword">const</span> { mountOrigin, publicPathname } = res.locals.podium.context;
<span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(publicPathname, mountOrigin);
<span class="hljs-comment">// url.href =&gt; &lt;mountOrigin&gt;/&lt;publicPathname&gt;</span>
<span class="hljs-comment">// eg. http://localhost:3040/cats/podium-resource</span></code></pre><h3 id="requests-from-non-layout-servers"><a class="header-link" href="#requests-from-non-layout-servers"></a>Requests from non Layout servers</h3>
<p>The Context is appended to requests from Layout servers to Podlet servers, but when testing the podlet in isolation you will want to be able to send requests to Podlets directly, bypassing Layouts entirely. Such requests will not
have the appropriate Context headers set and will therefore not be able to populate the <code>res.locals.podium.context</code> object.</p>
<p>To support this use case, a <code>.defaults()</code> method is provided on the <a href="https://github.schibsted.io/Podium/podlet">@podium/podlet</a> instance. In order to use this, you must set the <a href="https://github.schibsted.io/Podium/podlet">@podium/podlet</a> constructor argument <code>defaults</code> to <code>true</code>.</p>
<p><em>Example: enabling default context support in a Podlet</em></p>
<pre class="hljs"><code><span class="hljs-comment">// Enable defaults which will set a default Context</span>
<span class="hljs-keyword">const</span> podlet = <span class="hljs-keyword">new</span> Podlet({
    ...
    defaults: <span class="hljs-literal">true</span>,
});</code></pre><p><em>Example: setting default context values</em></p>
<pre class="hljs"><code><span class="hljs-comment">// Set default locale to Norwegian</span>
podlet.defaults({
    <span class="hljs-attr">locale</span>: <span class="hljs-string">'nb-NO'</span>,
});</code></pre><p>This is very handy during development, but it is advisable that these defaults
be turned off when running in production. Consider using <code>NODE_ENV</code> to enable/disable defaults based on the environment.</p>
<p><em>Example: disabling defaults in production</em></p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> podlet = <span class="hljs-keyword">new</span> Podlet({
    ...
    defaults: process.env.NODE_ENV !== <span class="hljs-string">'production'</span>,
});</code></pre><h3 id="client-side-javascript-and-the-context"><a class="header-link" href="#client-side-javascript-and-the-context"></a>Client side JavaScript and the context</h3>
<p>There are many occasions when you will want access to context values client side. Making AJAX requests to proxy endpoints and client side page navigation are two such common cases.</p>
<p>We recommend the following 2 step approach to sharing context values between backend node.js code and client side code.</p>
<ol class="list">
<li>write required context values to the dom in your content route</li>
<li>read from the dom in your client side code</li>
</ol>
<p><em>Example: writing context values to the dom in an express route</em></p>
<pre class="hljs"><code>app.get(<span class="hljs-string">'/'</span>, (req, res) =&gt; {
    <span class="hljs-keyword">const</span> {
        mountOrigin,
        mountPathname,
        publicPathname,
    } = res.locals.podium.context;

    res.send(<span class="hljs-string">`
        &lt;div 
            id="app"
            data-mount-origin="<span class="hljs-subst">${mountOrigin}</span>"
            data-mount-pathname="<span class="hljs-subst">${mountPathname}</span>"
            data-public-pathname="<span class="hljs-subst">${publicPathname}</span>"
        &gt;&lt;/div&gt;
    `</span>);
});</code></pre><p><em>Example: reading context values from the dom in client side JavaScript</em></p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> app = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'app'</span>);
<span class="hljs-keyword">const</span> { mountOrigin, mountPathname, publicPathname } = app.dataset;</code></pre><p><em>Example: constructing a URL in client side JavaScript</em></p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(mountPathname, mountOrigin).href;</code></pre><h2 id="putting-it-all-together"><a class="header-link" href="#putting-it-all-together"></a>Putting it all together</h2>
<p><em>Example: building a Podlet with a default context that passes values to the client</em></p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> Podlet = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@podium/podlet'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)();

<span class="hljs-comment">// Enable defaults which will set a default Context</span>
<span class="hljs-keyword">const</span> podlet = <span class="hljs-keyword">new</span> Podlet({
    <span class="hljs-attr">version</span>: <span class="hljs-string">'2.0.0'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'demo'</span>,

    <span class="hljs-comment">// turn defaults on for development</span>
    defaults: process.env,
});

<span class="hljs-comment">// Set default locale to Norwegian</span>
podlet.defaults({
    <span class="hljs-attr">locale</span>: <span class="hljs-string">'nb-NO'</span>,
});

<span class="hljs-comment">// mount middleware to ensure context headers are parsed</span>
app.use(podlet.middleware());

app.get(<span class="hljs-string">'/'</span>, (req, res, next) =&gt; {
    <span class="hljs-keyword">const</span> {
        mountOrigin,
        mountPathname,
        publicPathname,
        locale,
    } = res.locals.podium.context;

    <span class="hljs-comment">// offer one response to norwegian speakers...</span>
    <span class="hljs-keyword">if</span> (locale === <span class="hljs-string">'en-NO'</span>) {
        res.send(<span class="hljs-string">`
        &lt;div 
            id="app"
            data-mount-origin="<span class="hljs-subst">${mountOrigin}</span>"
            data-mount-pathname="<span class="hljs-subst">${mountPathname}</span>"
            data-public-pathname="<span class="hljs-subst">${publicPathname}</span>"
        &gt;
        Hei!
        &lt;/div&gt;
    `</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// ...and another to english speakers</span>
        res.send(<span class="hljs-string">'English is not supported at this time.'</span>);
    }
});</code></pre><p>Please see the <a href="https://github.schibsted.io/Podium/podlet">@podium/podlet</a> module for more detailed documentation.</p>
<h2 id="next-steps"><a class="header-link" href="#next-steps"></a>Next steps</h2>
<ul class="list">
<li><a href="/Podium/docs/podlets/proxying.html">learn about adding additional routes using the proxy</a></li>
<li><a href="/Podium/docs/podlets/local_development.html">read about improving your podlet development workflow</a></li>
</ul>
    </main>
  </div>
  <script>
    (function () {
      var pathname = window.location.pathname.substr(1);
      var activeLink = document.querySelector('a[href="' + pathname + '"]');

      activeLink.classList.add('selected');
    })();
  </script>
</body>
</html>
